<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sohbet Global | Realtime Chat</title>
    <style>
        :root {
            --bg-dark: #202225;
            --sidebar-bg: #2f3136;
            --chat-bg: #36393f;
            --accent: #5865f2;
            --text-main: #ffffff;
            --text-muted: #b9bbbe;
            --danger: #ed4245;
            --success: #3ba55c;
        }

        body { font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SOL PANEL (SIDEBAR) */
        #sidebar { width: 280px; background: var(--sidebar-bg); display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #202225; background: rgba(0,0,0,0.1); }
        .sidebar-content { padding: 15px; flex: 1; overflow-y: auto; }
        
        /* INPUT TASARIMLARI */
        .input-box { background: #202225; border-radius: 5px; padding: 10px; margin-bottom: 15px; }
        .input-box label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: bold; }
        input[type="text"] { width: 100%; background: transparent; border: none; color: white; padding: 5px 0; outline: none; margin-top: 5px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* KANAL LİSTESİ */
        .channel-list { margin-top: 20px; }
        .channel-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 2px; color: var(--text-muted); display: flex; align-items: center; }
        .channel-item:before { content: "#"; margin-right: 10px; font-size: 1.2rem; opacity: 0.5; }
        .channel-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .channel-item.active { background: rgba(255,255,255,0.1); color: white; font-weight: bold; }

        /* ANA SOHBET ALANI */
        #main { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); }
        #chat-header { height: 60px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #202225; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* MESAJ BALONU */
        .message { background: rgba(0,0,0,0.1); padding: 10px 15px; border-radius: 8px; border-left: 4px solid var(--accent); max-width: 90%; }
        .msg-info { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .msg-nick { font-weight: bold; }
        .msg-time { font-size: 0.75rem; color: var(--text-muted); }
        .msg-text { line-height: 1.4; word-wrap: break-word; }

        /* ÜYE LİSTESİ (SAĞ) */
        #user-sidebar { width: 240px; background: var(--sidebar-bg); padding: 20px; border-left: 1px solid #202225; }
        .user-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px; }
        .kick-btn { background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; visibility: hidden; }
        .user-item:hover .kick-btn { visibility: visible; }

        /* ALT MESAJ GİRİŞİ */
        #input-area { padding: 20px; background: var(--chat-bg); }
        .msg-input-wrapper { background: #40444b; border-radius: 8px; display: flex; padding: 5px 15px; }
        #msg-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">Sohbet Global</div>
    <div class="sidebar-content">
        <div class="input-box">
            <label>Profil Ayarların</label>
            <input type="text" id="nick-input" placeholder="Nick...">
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="btn btn-primary" style="font-size:12px;" onclick="fancyNick()">Şekilli</button>
                <input type="color" id="color-input" value="#ffffff" style="width:50px; height:35px; border:none; background:none; cursor:pointer;">
            </div>
            <button class="btn btn-success" onclick="updateProfile()">Güncelle</button>
        </div>

        <div class="input-box">
            <label>Yeni Kanal Aç</label>
            <input type="text" id="new-channel-input" placeholder="Kanal adı...">
            <button class="btn btn-primary" onclick="createNewChannel()">Katıl/Aç</button>
        </div>

        <div class="channel-list" id="channel-list">
            </div>
    </div>
</div>

<div id="main">
    <div id="chat-header"># <span id="current-channel-title">Global</span></div>
    <div id="messages"></div>
    <div id="input-area">
        <div class="msg-input-wrapper">
            <input type="text" id="msg-input" placeholder="Mesajınızı buraya yazın..." onkeypress="if(event.key === 'Enter') sendMsg()">
        </div>
    </div>
</div>

<div id="user-sidebar">
    <div style="font-size: 12px; color: var(--text-muted); font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">Üyeler — <span id="user-count">0</span></div>
    <div id="user-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update, serverTimestamp, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6e4oz3dUalcKrB5qWrLi4KeQ3G7-W7wY",
        authDomain: "online-chat-65a2a.firebaseapp.com",
        databaseURL: "https://online-chat-65a2a-default-rtdb.firebaseio.com",
        projectId: "online-chat-65a2a",
        storageBucket: "online-chat-65a2a.firebasestorage.app",
        messagingSenderId: "864284627272",
        appId: "1:864284627272:web:66b6cebe41afc4d23f637d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let myInfo = { uid: "", nick: "", color: "#ffffff" };
    let currentChannel = "Global";
    let joinedChannels = ["Global"];
    let isCreator = false;

    // 1. OTURUM VE PLAYER ATAMA
    signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => {
        if (user) {
            myInfo.uid = user.uid;
            const uRef = ref(db, 'users/' + user.uid);
            onValue(uRef, (snap) => {
                if (!snap.exists()) {
                    const id = Math.floor(Math.random() * 99);
                    myInfo.nick = "Player" + id;
                    set(uRef, myInfo);
                } else {
                    myInfo = snap.val();
                }
                document.getElementById('nick-input').value = myInfo.nick;
                document.getElementById('color-input').value = myInfo.color;
                switchChannel("Global");
            }, { onlyOnce: true });
        }
    });

    // 2. KANAL YÖNETİMİ
    window.switchChannel = (name) => {
        // Önceki dinleyicileri kapat
        off(ref(db, `channels/${currentChannel}/messages`));
        off(ref(db, `channels/${currentChannel}/users`));
        remove(ref(db, `channels/${currentChannel}/users/${myInfo.uid}`));

        // Yasaklı mıyız kontrol et
        onValue(ref(db, `channels/${name}/bans/${myInfo.uid}`), (snap) => {
            if (snap.exists()) {
                alert("Bu kanaldan yasaklandınız!");
                switchChannel("Global");
            } else {
                currentChannel = name;
                document.getElementById('current-channel-title').innerText = name;
                setupChannel(name);
                renderChannelList();
            }
        }, { onlyOnce: true });
    };

    function setupChannel(name) {
        // Kurucu kontrolü
        const cRef = ref(db, `channels/${name}/creator`);
        onValue(cRef, (snap) => {
            if (!snap.exists()) set(cRef, myInfo.uid);
            isCreator = (snap.val() === myInfo.uid || !snap.exists());
        }, { onlyOnce: true });

        // Kullanıcıyı odaya ekle
        const myActiveRef = ref(db, `channels/${name}/users/${myInfo.uid}`);
        set(myActiveRef, { nick: myInfo.nick, color: myInfo.color });
        onDisconnect(myActiveRef).remove();

        // Mesajları Dinle
        onValue(ref(db, `channels/${name}/messages`), (snap) => {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            snap.forEach(m => {
                const d = m.val();
                box.innerHTML += `
                    <div class="message">
                        <div class="msg-info">
                            <span class="msg-nick" style="color:${d.color}">${d.nick}</span>
                            <span class="msg-time">${new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="msg-text">${d.text}</div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        // Üyeleri Dinle
        onValue(ref(db, `channels/${name}/users`), (snap) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            let count = 0;
            snap.forEach(u => {
                count++;
                const ud = u.val();
                const isMe = u.key === myInfo.uid;
                list.innerHTML += `
                    <div class="user-item">
                        <span style="color:${ud.color}; font-weight:${isMe?'bold':'normal'}">${ud.nick} ${isMe?'(Sen)':''}</span>
                        ${isCreator && !isMe ? `<button class="kick-btn" onclick="kick('${u.key}')">At</button>` : ''}
                    </div>`;
            });
            document.getElementById('user-count').innerText = count;
        });
    }

    // 3. FONKSİYONLAR
    window.sendMsg = () => {
        const inp = document.getElementById('msg-input');
        if (!inp.value.trim()) return;
        push(ref(db, `channels/${currentChannel}/messages`), {
            nick: myInfo.nick,
            color: myInfo.color,
            text: inp.value,
            time: serverTimestamp()
        });
        inp.value = "";
    };

    window.updateProfile = () => {
        myInfo.nick = document.getElementById('nick-input').value;
        myInfo.color = document.getElementById('color-input').value;
        update(ref(db, 'users/' + myInfo.uid), myInfo);
        update(ref(db, `channels/${currentChannel}/users/${myInfo.uid}`), { nick: myInfo.nick, color: myInfo.color });
        alert("Profil güncellendi!");
    };

    window.createNewChannel = () => {
        const name = document.getElementById('new-channel-input').value.trim();
        if (name && !joinedChannels.includes(name)) {
            joinedChannels.push(name);
            switchChannel(name);
            document.getElementById('new-channel-input').value = "";
        }
    };

    window.renderChannelList = () => {
        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        joinedChannels.forEach(c => {
            list.innerHTML += `<div class="channel-item ${c === currentChannel ? 'active' : ''}" onclick="switchChannel('${c}')">${c}</div>`;
        });
    };

    window.kick = (targetUid) => {
        if (confirm("Bu kullanıcıyı kalıcı olarak atmak istiyor musun?")) {
            set(ref(db, `channels/${currentChannel}/bans/${targetUid}`), true);
            remove(ref(db, `channels/${currentChannel}/users/${targetUid}`));
        }
    };

    window.fancyNick = () => {
        const inp = document.getElementById('nick-input');
        const map = {a:'α',b:'в',c:'¢',d:'∂',e:'є',f:'ƒ',g:'g',h:'н',i:'ι',j:'נ',k:'к',l:'ℓ',m:'м',n:'η',o:'σ',p:'ρ',r:'я',s:'ѕ',t:'т',u:'υ',v:'ν',y:'у',z:'z'};
        inp.value = inp.value.split('').map(c => map[c.toLowerCase()] || c).join('');
    };
</script>

</body>
</html>
