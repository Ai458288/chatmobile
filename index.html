<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat & Kanal Sistemi</title>
    <style>
        :root { --bg: #1a1a1a; --panel: #2d2d2d; --text: #e0e0e0; --accent: #7289da; --active: #43b581; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 260px; background: var(--panel); border-right: 1px solid #444; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        input, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: none; outline: none; box-sizing: border-box; }
        input { background: #40444b; color: white; }
        button { background: var(--accent); color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }

        /* Kanal Listesi */
        .section-title { font-size: 0.8em; color: #888; text-transform: uppercase; margin: 15px 0 5px; font-weight: bold; }
        #channel-list { display: flex; flex-direction: column; gap: 5px; }
        .channel-item { padding: 10px; background: #36393f; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: 0.2s; border-left: 3px solid transparent; }
        .channel-item:hover { background: #40444b; }
        .channel-item.active { background: #40444b; border-left-color: var(--active); color: white; }

        /* Ana Alan */
        #main-container { flex: 1; display: flex; flex-direction: column; }
        #chat-header { padding: 15px; background: var(--panel); border-bottom: 1px solid #444; font-weight: bold; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px 15px; border-radius: 8px; background: #32353b; max-width: 85%; align-self: flex-start; }
        .msg-header { font-size: 0.85em; font-weight: bold; margin-bottom: 4px; }

        /* Üye Menüsü */
        #member-menu { width: 200px; background: var(--panel); border-left: 1px solid #444; padding: 15px; }
        @media (max-width: 768px) { #member-menu { display: none; } } /* Mobilde üyeleri gizle */
        .member-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9em; }
        .kick-btn { background: #f04747; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 0.7em; }

        #input-area { padding: 15px; background: var(--bg); display: flex; gap: 10px; border-top: 1px solid #333; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="margin-top:0;">Sohbet Global</h3>
    
    <div class="input-group">
        <input type="text" id="nick-input" placeholder="Nick...">
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button onclick="applyFancyNick()" style="flex:1;">Şekilli</button>
            <input type="color" id="color-picker" value="#ffffff" style="width:50px; padding:2px; height:40px;">
        </div>
        <button onclick="updateProfile()" style="background: var(--active);">Kaydet</button>
    </div>

    <div class="section-title">Yeni Kanal Aç/Katıl</div>
    <div class="input-group">
        <input type="text" id="channel-input" placeholder="Kanal adı...">
        <button onclick="joinChannelAction()">Giriş Yap</button>
    </div>

    <div class="section-title">Kanallarım</div>
    <div id="channel-list">
        </div>
    
    <div id="status" style="font-size: 0.7em; color: #888; margin-top:auto; padding-top:10px;">Bağlanıyor...</div>
</div>

<div id="main-container">
    <div id="chat-header">Kanal: <span id="current-channel-name">Yükleniyor...</span></div>
    <div id="messages"></div>
    <div id="input-area">
        <input type="text" id="msg-input" placeholder="Mesajınızı yazın...">
        <button onclick="sendMessage()" style="width: 80px;">Gönder</button>
    </div>
</div>

<div id="member-menu">
    <div class="section-title">Üyeler</div>
    <div id="member-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6e4oz3dUalcKrB5qWrLi4KeQ3G7-W7wY",
        authDomain: "online-chat-65a2a.firebaseapp.com",
        databaseURL: "https://online-chat-65a2a-default-rtdb.firebaseio.com",
        projectId: "online-chat-65a2a",
        storageBucket: "online-chat-65a2a.firebasestorage.app",
        messagingSenderId: "864284627272",
        appId: "1:864284627272:web:66b6cebe41afc4d23f637d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let myData = { uid: "", nick: "", color: "#ffffff" };
    let currentChannel = null;
    let myChannels = ["Global"]; // Varsayılan kanal

    // Giriş ve Profil
    signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => {
        if (user) {
            myData.uid = user.uid;
            const userRef = ref(db, 'users/' + user.uid);
            onValue(userRef, (snapshot) => {
                if (!snapshot.exists()) {
                    const randomId = Math.floor(Math.random() * 999);
                    myData.nick = "Player" + randomId;
                    set(userRef, myData);
                } else {
                    myData = snapshot.val();
                }
                document.getElementById('nick-input').value = myData.nick;
                document.getElementById('color-picker').value = myData.color;
                document.getElementById('status').innerText = "Aktif: " + myData.nick;
                
                // İlk girişte Global'e bağlan
                if(!currentChannel) switchChannel("Global");
            }, { onlyOnce: true });
        }
    });

    // Kanal Değiştirme ve Listeleme
    window.switchChannel = (channelName) => {
        if (currentChannel === channelName) return;
        
        // Önceki dinleyicileri temizle
        if (currentChannel) {
            off(ref(db, `channels/${currentChannel}/messages`));
            off(ref(db, `channels/${currentChannel}/activeUsers`));
            remove(ref(db, `channels/${currentChannel}/activeUsers/${myData.uid}`));
        }

        currentChannel = channelName;
        document.getElementById('current-channel-name').innerText = channelName;
        renderChannelList();

        // Kanala giriş kaydı
        set(ref(db, `channels/${channelName}/activeUsers/${myData.uid}`), { nick: myData.nick, color: myData.color });

        // Mesajları Getir
        onValue(ref(db, `channels/${channelName}/messages`), (snapshot) => {
            const msgDiv = document.getElementById('messages');
            msgDiv.innerHTML = "";
            snapshot.forEach((child) => {
                const data = child.val();
                msgDiv.innerHTML += `
                    <div class="message">
                        <div class="msg-header" style="color: ${data.color}">${data.sender}</div>
                        <div>${data.text}</div>
                    </div>`;
            });
            msgDiv.scrollTop = msgDiv.scrollHeight;
        });

        // Üyeleri Getir
        onValue(ref(db, `channels/${channelName}/activeUsers`), (snapshot) => {
            const listDiv = document.getElementById('member-list');
            listDiv.innerHTML = "";
            snapshot.forEach((child) => {
                const user = child.val();
                listDiv.innerHTML += `<div class="member-item"><span style="color:${user.color}">${user.nick}</span></div>`;
            });
        });
    };

    function renderChannelList() {
        const listDiv = document.getElementById('channel-list');
        listDiv.innerHTML = "";
        myChannels.forEach(ch => {
            const activeClass = ch === currentChannel ? "active" : "";
            listDiv.innerHTML += `<div class="channel-item ${activeClass}" onclick="switchChannel('${ch}')"># ${ch}</div>`;
        });
    }

    window.joinChannelAction = () => {
        const name = document.getElementById('channel-input').value.trim();
        if(name && !myChannels.includes(name)) {
            myChannels.push(name);
            switchChannel(name);
            document.getElementById('channel-input').value = "";
        }
    };

    window.sendMessage = () => {
        const input = document.getElementById('msg-input');
        if (!input.value.trim()) return;
        push(ref(db, `channels/${currentChannel}/messages`), {
            sender: myData.nick,
            text: input.value,
            color: myData.color,
            timestamp: serverTimestamp()
        });
        input.value = "";
    };

    window.updateProfile = () => {
        const n = document.getElementById('nick-input').value;
        const c = document.getElementById('color-picker').value;
        update(ref(db, 'users/' + myData.uid), { nick: n, color: c });
        myData.nick = n; myData.color = c;
        if(currentChannel) set(ref(db, `channels/${currentChannel}/activeUsers/${myData.uid}`), { nick: n, color: c });
        alert("Güncellendi!");
    };

    window.applyFancyNick = () => {
        const input = document.getElementById('nick-input');
        const map = { 'a': 'α', 'b': 'в', 's': 'ѕ', 'e': 'є', 'l': 'ℓ', 'm': 'м' }; // Örnek harfler
        input.value = input.value.split('').map(char => map[char.toLowerCase()] || char).join('');
    };
</script>
</body>
</html>
